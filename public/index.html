
<script>
  let userId = '', username = '', userRoles = [];

  async function getUser() {
    try {
      const discord_id = localStorage.getItem('discord_id');
      const usernameLS = localStorage.getItem('username');

      if (!discord_id && !usernameLS) throw new Error('Missing user info');

      const res = await fetch('/api/user', {
        headers: {
          'x-discord-id': discord_id || '',
          'x-username': usernameLS || ''
        }
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to fetch user');

      userId = data.discord_id;
      username = data.username;
      userRoles = data.roles || [];

      if (!userRoles.includes("lets pruv it")) {
        document.querySelector('.submit-idea').style.display = 'none';
      }
    } catch (err) {
      console.error('User fetch failed:', err);
    }
  }

  async function loadIdeas() {
    const res = await fetch('/api/ideas');
    const { ideas, totalVotes } = await res.json();
    const container = document.getElementById('ideaCards');
    container.innerHTML = '';

    const counter = document.getElementById('voteCounter');
    if (counter) counter.textContent = `ðŸ”Ž Total verified SP1 votes: ${totalVotes}`;

    ideas.forEach((i, idx) => {
      const card = document.createElement('div');
      card.className = 'idea-card';
      card.innerHTML = `
        <p class="idea-text">#${idx + 1} â€” ${i.idea}</p>
        <span class="username">by @${i.username || 'unknown'}</span>
        <span class="votes">${i.votes} vote${i.votes === 1 ? '' : 's'}</span>
        ${userRoles.includes('Proof Verified') ? `<button onclick="voteIdea(${idx}, this)">ðŸ”Ž Vote with SP1</button>` : ''}
      `;
      container.appendChild(card);
    });
  }

  async function voteIdea(index, button) {
    button.disabled = true;
    button.textContent = 'Verifying...';

    const res = await fetch('/api/vote', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ index, discord_id: userId })
    });
    const data = await res.json();

    if (data.success) {
      alert('âœ… Vote verified with SP1!');
      loadIdeas();
    } else {
      alert(data.error || 'âŒ Voting failed.');
      button.disabled = false;
      button.textContent = 'ðŸ”Ž Vote with SP1';
    }
  }

  document.getElementById('ideaForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const ideaText = document.getElementById('ideaText').value.trim();
    if (!ideaText) return;

    const res = await fetch('/api/submit-idea', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        idea: ideaText,
        discord_id: userId,
        username: username
      })
    });

    const data = await res.json();
    if (data.success) {
      alert('âœ… Idea submitted and verified!');
      document.getElementById('ideaText').value = '';
      loadIdeas();
    } else {
      alert(data.error || 'âŒ Submission failed.');
    }
  });

  // Guardar parÃ¡metros del callback
  window.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const discord_id = params.get('discord_id');
    const username = params.get('username');
    const avatar = params.get('avatar_url');

    if (discord_id && username) {
      localStorage.setItem('discord_id', discord_id);
      localStorage.setItem('username', username);
      localStorage.setItem('avatar_url', avatar);
      window.history.replaceState({}, document.title, '/');
    }
  });

  async function loadUserProfileCard() {
    try {
      const res = await fetch('/api/user');
      if (!res.ok) throw new Error('Not authenticated');
      const user = await res.json();

      const allowedRoles = ['Proof Verified', 'lets pruv it'];
      const hasAccess = user.roles.some(role =>
        allowedRoles.map(r => r.toLowerCase()).includes(role.toLowerCase())
      );
      if (!hasAccess) return;

      document.getElementById('discordUsername').textContent = `@${user.username}`;
      document.getElementById('discordAvatar').src = user.avatar_url;

      const ROLE_STYLES = {
        "PROVED UR LUV": "#ff66cc",
        "PROOF OF ART": "#00e6e6",
        "PROOF OF DEV": "#9999ff",
        "PROOF OF MUSIC": "#66cccc",
        "PROOF OF VIDEO": "#cc99ff",
        "Proof Verified": "#55d6aa",
        "lets pruv it": "#ff9999",
        "ZK EVENTS": "#ff6699",
        "X PROVER": "#ff4da6",
        "DEV CHANNEL": "#6666ff",
        "ALL IN SUCCINCT": "#ffcc66",
        "RUSTACEAN": "#cc6600",
        "SUCCINCT CRACKED EMPLOYEE": "#ff0066",
        "HELPER PROVER": "#ffcc00",
        "STAFF PROVER": "#ff3399",
        "ðŸ‡ªðŸ‡¸ãƒ»espaÃ±ol": "#cccccc",
        "Dev Helper": "#8888ff",
        "Beta Prover": "#cc00cc"
      };

      const roleTags = document.getElementById('roleTags');
      user.roles.forEach(role => {
        const tag = document.createElement('span');
        tag.textContent = role;
        const color = ROLE_STYLES[role] || '#90DCFF';
        tag.style.cssText = `
          background-color: #1A1A2B;
          color: ${color};
          border: 1px solid ${color};
          border-radius: 12px;
          padding: 0.3rem 0.7rem;
          font-size: 0.9rem;
        `;
        roleTags.appendChild(tag);
      });

      document.querySelector('.profile-card').style.display = 'block';
    } catch (e) {
      console.log('User not authenticated or unauthorized for profile card.');
    }
  }

  getUser().then(() => {
    loadIdeas();
    loadUserProfileCard();
  });
</script>


