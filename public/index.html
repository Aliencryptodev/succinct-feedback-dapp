<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Succinct Feedback DApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script>
    const BACKEND_URL = 'http://217.65.144.64:3000';
  </script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0A0A0A;
      color: white;
      font-family: sans-serif;
      display: flex;
    }
    .sidebar {
      width: 180px;
      background-color: #800080;
      padding: 1rem 0.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      min-height: 100vh;
    }
    .sidebar button {
      background-color: #FE11C5;
      color: white;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
    }
    .main-content {
      flex-grow: 1;
      padding: 2rem;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .profile-card {
      max-width: 500px;
      margin: 2rem auto;
      padding: 2rem;
      background-color: #0F0F1A;
      border: 2px solid #00FFFF;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,255,255,0.3);
      color: white;
      text-align: center;
    }
    .idea-card {
      background-color: #111;
      border: 1px solid #FE11C5;
      border-radius: 12px;
      padding: 1rem;
      width: 300px;
      text-align: left;
      box-shadow: 0 0 10px #FE11C533;
      margin: 1rem auto;
    }
    .cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }
    textarea {
      width: 90%;
      max-width: 500px;
      height: 100px;
      border-radius: 8px;
      border: none;
      padding: 1rem;
      font-size: 1rem;
    }
    .submit-button {
      background-color: #FE11C5;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <button onclick="showSection('dashboard')">üè† Dashboard</button>
    <button onclick="showSection('create')">üí° Create Idea</button>
    <button onclick="showSection('vote')">üó≥Ô∏è Vote</button>
  </div>
  <div class="main-content">
    <div id="dashboard" class="section active">
      <h1>Welcome</h1>
      <p>Backed by your ideas, verified by zero-knowledge proofs.</p>
      <a href="https://discord.com/api/oauth2/authorize?client_id=1371930922877849651&redirect_uri=http%3A%2F%2F217.65.144.64%3A3000%2Fcallback&response_type=code&scope=identify%20guilds.members.read">
        <button>Connect with Discord</button>
      </a>
      <div class="profile-card" id="profileCard" style="display:none;">
        <img id="discordAvatar" style="width:100px;height:100px;border-radius:50%;border:3px solid #FE11C5;" />
        <h2 id="discordUsername" style="color:#FE11C5;"></h2>
        <div id="roleTags" style="display:flex;flex-wrap:wrap;justify-content:center;gap:0.5rem;"></div>
        <div id="voteCountDisplay" style="margin-top:1rem; color:#F9E766;"></div>
      </div>
    </div>
    <div id="create" class="section">
      <h2>Submit Your Idea</h2>
      <form id="ideaForm">
        <textarea id="ideaText" placeholder="Describe your idea..." required></textarea><br>
        <button type="submit" class="submit-button">Submit Idea</button>
      </form>
    </div>
    <div id="vote" class="section">
      <h2>Leaderboard</h2>
      <div id="ideaCards" class="cards"></div>
      <div id="voteCounter" style="text-align:center; margin-top:1rem;"></div>
      <h2 style="color:#FF5555;">Discarded Ideas</h2>
      <div id="discardedIdeas" class="cards"></div>
    </div>
  </div>
  <script>
    const ROLE_STYLES = {
      "PROOF VERIFIED": "#55d6aa", "LET'S PRUV IT": "#ff9999", "ZK EVENTS": "#ff6699", "X PROVER": "#ff4da6"
    };
    const BACKEND_URL = 'http://217.65.144.64:3000';
    let userId = '', username = '', userRoles = [];

    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    async function getUser() {
      try {
        const res = await fetch(`${BACKEND_URL}/api/user`);
        const data = await res.json();
        userId = data.discord_id;
        username = data.username;
        userRoles = data.roles || [];
        document.getElementById('discordAvatar').src = data.avatar_url;
        document.getElementById('discordUsername').textContent = '@' + username;
        const roleTags = document.getElementById('roleTags');
        roleTags.innerHTML = '';
        data.roles.forEach(role => {
          const span = document.createElement('span');
          span.textContent = role;
          span.style.cssText = `
            background-color: #1A1A2B; color: ${ROLE_STYLES[role.toUpperCase()] || '#90DCFF'};
            border: 1px solid ${ROLE_STYLES[role.toUpperCase()] || '#90DCFF'};
            border-radius: 12px; padding: 0.3rem 0.7rem; font-size: 0.9rem;
          `;
          roleTags.appendChild(span);
        });
        document.getElementById('voteCountDisplay').textContent = `üó≥Ô∏è Votos disponibles: ${data.remaining_votes}`;
        document.getElementById('profileCard').style.display = 'block';
      } catch (e) {}
    }

    async function loadIdeas() {
      const res = await fetch(`${BACKEND_URL}/ideas`);
      const { ideas, totalVotes } = await res.json();
      const container = document.getElementById('ideaCards');
      container.innerHTML = '';
      document.getElementById('voteCounter').textContent = `üîé Total verified SP1 votes: ${totalVotes}`;
      ideas.forEach((i, idx) => {
        const card = document.createElement('div');
        card.className = 'idea-card';
        card.innerHTML = `
          <p class="idea-text">#${idx + 1} ‚Äî ${i.idea}</p>
          <span class="username">by @${i.username || 'unknown'}</span>
          <span class="votes">${i.votes} vote${i.votes === 1 ? '' : 's'}</span>
          <input type="number" id="voteInput${idx}" min="1" placeholder="Votes" style="width:60px;" />
          <button onclick="voteIdea(${idx}, this)">üîé Vote</button>
        `;
        container.appendChild(card);
      });
    }

    async function voteIdea(index, button) {
      const input = document.getElementById(`voteInput${index}`);
      const amount = parseInt(input?.value || '1', 10);
      if (!amount || amount < 1) return alert("‚ùå Ingresa una cantidad v√°lida de votos");
      button.disabled = true;
      button.textContent = 'Verificando...';
      const res = await fetch(`${BACKEND_URL}/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index, discord_id: userId, username, amount })
      });
      const data = await res.json();
      if (data.success) {
        alert(`‚úÖ Votaste con ${amount} voto${amount === 1 ? '' : 's'}`);
        loadIdeas();
      } else {
        alert(data.error || '‚ùå Fall√≥ el voto');
        button.disabled = false;
        button.textContent = 'üîé Vote';
      }
    }

    document.getElementById('ideaForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const ideaText = document.getElementById('ideaText').value.trim();
      if (!ideaText) return;
      const res = await fetch(`${BACKEND_URL}/submit-idea`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idea: ideaText, discord_id: userId, username })
      });
      const data = await res.json();
      if (data.success) {
        alert('‚úÖ Idea submitted!');
        document.getElementById('ideaText').value = '';
        loadIdeas();
      } else alert(data.error || '‚ùå Submission failed.');
    });

    async function loadDiscardedIdeas() {
      const res = await fetch(`${BACKEND_URL}/message.json`);
      const messages = await res.json();
      const container = document.getElementById('discardedIdeas');
      container.innerHTML = '';
      messages.forEach(msg => {
        const card = document.createElement('div');
        card.className = 'idea-card';
        card.innerHTML = `<p class="idea-text">üóëÔ∏è ${msg.idea}</p><span class="votes" style="color: #FF8888;">Reason: ${msg.reason}</span>`;
        container.appendChild(card);
      });
    }

    getUser().then(() => {
      loadIdeas();
      loadDiscardedIdeas();
    });
  </script>
</body>
</html>