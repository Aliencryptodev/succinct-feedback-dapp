
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Succinct Feedback DApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0A0A0A;
      color: white;
      font-family: sans-serif;
    }
    .hero {
      padding: 4rem 2rem 2rem;
      text-align: center;
    }
    .hero h1 {
      font-size: 2.5rem;
      color: #FE11C5;
      margin-bottom: 1rem;
    }
    .hero p {
      font-size: 1.2rem;
      max-width: 600px;
      margin: 0 auto;
      color: #90DCFF;
    }
    .leaderboard {
      padding: 2rem;
      text-align: center;
    }
    .leaderboard h2 {
      color: #F9E766;
    }
    .cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      padding-top: 1rem;
    }
    .idea-card {
      background-color: #111;
      border: 1px solid #FE11C5;
      border-radius: 12px;
      padding: 1rem;
      width: 300px;
      text-align: left;
      box-shadow: 0 0 10px #FE11C533;
      transition: transform 0.2s ease;
    }
    .idea-card:hover {
      transform: scale(1.02);
    }
    .idea-text {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    .username {
      color: #90DCFF;
      font-size: 0.9rem;
    }
    .votes {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.95rem;
      color: #F9E766;
      font-weight: bold;
    }
    .submit-idea {
      padding: 3rem 2rem;
      text-align: center;
    }
    textarea {
      width: 90%;
      max-width: 500px;
      height: 100px;
      border-radius: 8px;
      border: none;
      padding: 1rem;
      font-size: 1rem;
    }
    button {
      background-color: #FE11C5;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      margin-top: 1rem;
    }
    #notification {
      display: none;
      background-color: #F9E766;
      color: black;
      padding: 1rem;
      text-align: center;
      font-weight: bold;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }
    .profile-card {
      display: none;
      max-width: 500px;
      margin: 3rem auto;
      padding: 2rem;
      background-color: #0F0F1A;
      border: 2px solid #00FFFF;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,255,255,0.3);
      color: white;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="notification">âœ… Idea submitted successfully!</div>

  <section class="hero">
    <h1>Shape Succinctâ€™s future</h1>
    <p>Backed by your ideas, verified by zero-knowledge proofs.</p>
    <a href="https://discord.com/api/oauth2/authorize?client_id=1371241967542861896&redirect_uri=https%3A%2F%2Fsuccinct-feedback-dapp.vercel.app%2Fapi%2Fcallback&response_type=code&scope=identify%20guilds.members.read">
      <button>Connect with Discord</button>
    </a>
  </section>

  <div class="profile-card">
    <div class="avatar-section">
      <img id="discordAvatar" alt="avatar" style="width:100px; height:100px; border-radius:100%; border:3px solid #FE11C5;">
      <h2 id="discordUsername" style="margin-top:1rem; color:#FE11C5; font-size:1.4rem;">@usuario</h2>
    </div>
    <div class="roles-section">
      <h3 style="color:#90DCFF; margin-bottom:0.5rem;">Roles:</h3>
      <div id="roleTags" style="display:flex; flex-wrap:wrap; justify-content:center; gap:0.5rem;"></div>
    </div>
  </div>

  <section class="leaderboard">
    <h2>Leaderboard</h2>
    <div id="ideaCards" class="cards">
      <p>Loading...</p>
    </div>
  </section>

  <section class="submit-idea">
    <h2 style="color: #F9E766;">Submit your idea</h2>
    <form id="ideaForm">
      <textarea id="ideaText" placeholder="Describe your idea..." required></textarea><br>
      <button type="submit">Submit Idea</button>
    </form>
  </section>

  <div id="voteCounter" style="text-align:center; font-size:1.2rem; color:#00FFFF; margin-top:1rem;"></div>

  <script>
    let userId = '', username = '', userRoles = [];

    async function getUser() {
  try {
    const discord_id = localStorage.getItem('discord_id');
    const username = localStorage.getItem('username');

    if (!discord_id && !username) {
      throw new Error('Missing user info');
    }

    const res = await fetch('/api/user', {
      headers: {
        'x-discord-id': discord_id || '',
        'x-username': username || ''
      }
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Failed to fetch user');

    userId = data.discord_id;
    username = data.username;
    userRoles = data.roles || [];

    if (!userRoles.includes("lets pruv it")) {
      document.querySelector('.submit-idea').style.display = 'none';
    }

  } catch (err) {
    console.error('User fetch failed:', err);
  }
}

    async function loadIdeas() {
      const res = await fetch('/api/ideas');
      const { ideas, totalVotes } = await res.json();
      const container = document.getElementById('ideaCards');
      container.innerHTML = '';

      const counter = document.getElementById('voteCounter');
      if (counter) counter.textContent = `ðŸ”Ž Total verified SP1 votes: ${totalVotes}`;

      ideas.forEach((i, idx) => {
        const card = document.createElement('div');
        card.className = 'idea-card';
        card.innerHTML = `
          <p class="idea-text">#${idx + 1} â€” ${i.idea}</p>
          <span class="username">by @${i.username || 'unknown'}</span>
          <span class="votes">${i.votes} vote${i.votes === 1 ? '' : 's'}</span>
          ${userRoles.includes('Proof Verified') ? `<button onclick="voteIdea(${idx}, this)">ðŸ”Ž Vote with SP1</button>` : ''}
        `;
        container.appendChild(card);
      });
    }

    async function voteIdea(index, button) {
      button.disabled = true;
      button.textContent = 'Verifying...';

      const res = await fetch('/api/vote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ index, discord_id: userId })
      });
      const data = await res.json();

      if (data.success) {
        alert('âœ… Vote verified with SP1!');
        loadIdeas();
      } else {
        alert(data.error || 'âŒ Voting failed.');
        button.disabled = false;
        button.textContent = 'ðŸ”Ž Vote with SP1';
      }
    }

    const ROLE_STYLES = {
      "PROVED UR LUV": "#ff66cc",
      "PROOF OF ART": "#00e6e6",
      "PROOF OF DEV": "#9999ff",
      "PROOF OF MUSIC": "#66cccc",
      "PROOF OF VIDEO": "#cc99ff",
      "Proof Verified": "#55d6aa",
      "lets pruv it": "#ff9999",
      "ZK EVENTS": "#ff6699",
      "X PROVER": "#ff4da6",
      "DEV CHANNEL": "#6666ff",
      "ALL IN SUCCINCT": "#ffcc66",
      "RUSTACEAN": "#cc6600",
      "SUCCINCT CRACKED EMPLOYEE": "#ff0066",
      "HELPER PROVER": "#ffcc00",
      "STAFF PROVER": "#ff3399",
      "ðŸ‡ªðŸ‡¸ãƒ»espaÃ±ol": "#cccccc",
      "ðŸ‡¨ðŸ‡³ãƒ»ä¸­æ–‡": "#cccccc",
      "ðŸ‡»ðŸ‡³ãƒ»tiáº¿ng-viá»‡t": "#cccccc",
      "ðŸ‡®ðŸ‡©ãƒ»indonesia": "#cccccc",
      "ðŸ‡¹ðŸ‡·ãƒ»tÃ¼rkÃ§e": "#cccccc",
      "ðŸ‡·ðŸ‡ºãƒ»Ñ€ÑƒÑÑÐºÐ¸Ð¹": "#cccccc",
      "ðŸ‡µðŸ‡±ãƒ»polski": "#cccccc",
      "ðŸ‡§ðŸ‡·ãƒ»portuguÃªs": "#cccccc",
      "ðŸ‡®ðŸ‡³ãƒ»à¤¹à¤¿à¤¨à¥à¤¦à¥€": "#cccccc",
      "Dev Helper": "#8888ff",
      "Beta Prover": "#cc00cc"
    };

    async function loadUserProfileCard() {
      try {
        const res = await fetch('http://217.65.144.64:3000/api/user');
        if (!res.ok) throw new Error('Not authenticated');
        const user = await res.json();

        const allowedRoles = ['Proof Verified', 'lets pruv it'];
        const hasAccess = user.roles.some(role =>
          allowedRoles.map(r => r.toLowerCase()).includes(role.toLowerCase())
        );

        if (!hasAccess) return;

        document.getElementById('discordUsername').textContent = `@${user.username}`;
        document.getElementById('discordAvatar').src = user.avatar_url;

        const roleTags = document.getElementById('roleTags');
        user.roles.forEach(role => {
          const tag = document.createElement('span');
          tag.textContent = role;
          const color = ROLE_STYLES[role] || '#90DCFF';
          tag.style.cssText = `
            background-color: #1A1A2B;
            color: ${color};
            border: 1px solid ${color};
            border-radius: 12px;
            padding: 0.3rem 0.7rem;
            font-size: 0.9rem;
          `;
          roleTags.appendChild(tag);
        });

        document.querySelector('.profile-card').style.display = 'block';
      } catch (e) {
        console.log('User not authenticated or unauthorized for profile card.');
      }
    }

    document.getElementById('ideaForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const ideaText = document.getElementById('ideaText').value.trim();
      if (!ideaText) return;

      const res = await fetch('/api/ideas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          idea: ideaText,
          discord_id: userId,
          username: username
        })
      });

      const data = await res.json();
      if (data.success) {
        alert('âœ… Idea submitted and verified!');
        document.getElementById('ideaText').value = '';
        loadIdeas();
      } else {
        alert(data.error || 'âŒ Submission failed.');
      }
    });

     // Extrae los datos del callback y los guarda en localStorage
  window.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const discord_id = params.get('discord_id');
    const username = params.get('username');
    const avatar = params.get('avatar');

    if (discord_id && username) {
      localStorage.setItem('discord_id', discord_id);
      localStorage.setItem('username', username);
      localStorage.setItem('avatar_url', avatar);
      // Limpia la URL
      window.history.replaceState({}, document.title, '/');
    }
   });
    
      getUser().then(() => {
      loadIdeas();
      loadUserProfileCard();
    });
   </script>
   </body>
   </html>

